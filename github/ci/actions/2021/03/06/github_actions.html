<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Github Actions are Awesome! | JC’s Blog</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Github Actions are Awesome!" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Or how I learned to automatically update the header image." />
<meta property="og:description" content="Or how I learned to automatically update the header image." />
<link rel="canonical" href="https://jc639.github.io/blog/github/ci/actions/2021/03/06/github_actions.html" />
<meta property="og:url" content="https://jc639.github.io/blog/github/ci/actions/2021/03/06/github_actions.html" />
<meta property="og:site_name" content="JC’s Blog" />
<meta property="og:image" content="https://jc639.github.io/blog/images/header.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-03-06T00:00:00-06:00" />
<script type="application/ld+json">
{"url":"https://jc639.github.io/blog/github/ci/actions/2021/03/06/github_actions.html","@type":"BlogPosting","headline":"Github Actions are Awesome!","dateModified":"2021-03-06T00:00:00-06:00","datePublished":"2021-03-06T00:00:00-06:00","image":"https://jc639.github.io/blog/images/header.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://jc639.github.io/blog/github/ci/actions/2021/03/06/github_actions.html"},"description":"Or how I learned to automatically update the header image.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/blog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jc639.github.io/blog/feed.xml" title="JC's Blog" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-190736870-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/blog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=PT+Sans&family=Russo+One&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bungee&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet"> 
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/blog/">JC&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/blog/about/">About Me</a><a class="page-link" href="/blog/search/">Search</a><a class="page-link" href="/blog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Github Actions are Awesome!</h1><p class="page-description">Or how I learned to automatically update the header image.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-03-06T00:00:00-06:00" itemprop="datePublished">
        Mar 6, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/blog/categories/#Github">Github</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#CI">CI</a>
        &nbsp;
      
        <a class="category-tags-link" href="/blog/categories/#Actions">Actions</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-03-06-github_actions.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Github Actions are a way to automate your workflow so you can build continuous-integration/continuous development (CI/CD) workflows. You can run tests, check your library or package can build, generate and commit new files all on various triggers such as pushes, pull requests or even schedules. It's really awesome for automating lots of different tasks and with scripts the possibilities are endless. It's even how this website gets built.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fastpages">Fastpages<a class="anchor-link" href="#Fastpages"> </a></h2><p>This website is built with the amazing <a href="https://github.com/fastai/fastpages">fastpages</a>, which alongside <a href="https://nbdev.fast.ai/">nbdev</a> is great for a gentle introduction to Github Actions.</p>
<p>Fastpages allows me to write this post in a <a href="https://github.com/jc639/blog/blob/master/_notebooks/2021-03-06-github_actions.ipynb">Jupyter notebook</a>, and then when I push these notebooks to the blog repository an action takes place that converts them to markdown files and builds the Jekyll site that you are looking at now.</p>
<p>I think this is really neat but I thought it would also be cool to use this workflow to generate an ever-changing header for the front page that is based on the blog posts that have been published recently.</p>
<p><img src="/blog/images/copied_from_nb/../images/header_copy.png" alt="title" title="An example header - each post and title in the last 30 days is shown" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="An-action-workflow">An action workflow<a class="anchor-link" href="#An-action-workflow"> </a></h2><p>Fastpages comes with a CI YAML file that looks something like this. I will break this down bit by bit to explain and then show how I modified it so that a new header is generated both when pushing new notebooks and on a schedule:</p>

<pre><code>name: CI
on:
  push:
    branches:
      - master # need to filter here so we only deploy when there is a push to master
  # no filters on pull requests, so intentionally left blank
  pull_request:
  workflow_dispatch:

jobs:     
  build-site:
    if: ( github.event.commits[0].message != 'Initial commit' ) || github.run_number &gt; 1
    runs-on: ubuntu-latest
    steps:

    - name: Check if secret exists
      if: github.event_name == 'push'
      run: |
        if [ -z "$deploy_key" ]
        then
          echo "You do not have a secret named SSH_DEPLOY_KEY.  This means you did not follow the setup instructions carefully.  Please try setting up your repo again with the right secrets."
          exit 1;
        fi
      env:
       deploy_key: $


    - name: Copy Repository Contents
      uses: actions/checkout@main
      with:
        persist-credentials: false

    - name: convert notebooks and word docs to posts
      uses: ./_action_files

    - name: setup directories for Jekyll build
      run: |
        rm -rf _site
        sudo chmod -R 777 .

    - name: Jekyll build
      uses: docker://fastai/fastpages-jekyll
      with:
        args: bash -c "jekyll build -V --strict_front_matter --trace"
      env:
        JEKYLL_ENV: 'production'

    - name: copy CNAME file into _site if CNAME exists
      run: |
        sudo chmod -R 777 _site/
        cp CNAME _site/ 2&gt;/dev/null || :

    - name: Deploy
      if: github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: $
        publish_dir: ./_site</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The first bit sets up when the Action file gets run. The following gives the Action a name and specifies it should run on a push to master branch, or pull requests. The <code>workflow_dispatch:</code> allows manual triggering of the workflow from the actions tab or REST API on Github.</p>

<pre><code>name: CI
on:
  push:
    branches:
      - master # need to filter here so we only deploy when there is a push to master
  # no filters on pull requests, so intentionally left blank
  pull_request:
  workflow_dispatch:</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, we set up the job and what it runs on - here it is the latest ubuntu image. What this means is that each time this runs we get a self-contained environment in which to carry out the steps of the workflow. You can see below that we can sprinkle our action files with conditional <code>if: ...</code> statements allowing control flow in our actions.</p>

<pre><code>jobs:     
  build-site:
    if: ( github.event.commits[0].message != 'Initial commit' ) || github.run_number &gt; 1
    runs-on: ubuntu-latest</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now it's time to define the actual steps that we want to execute. The key part here is that we give the step a name and then either have a <code>run:</code> or <code>uses:</code> key for the given step. If we have a <code>run:</code> key we can execute statements as if we were in the bash terminal (this being a ubuntu image) such as <code>cd ..</code> or <code>ls</code> etc.</p>
<p>The <code>use:</code> allows us to use specific actions created by others - of which there are many on the <a href="https://github.com/marketplace?type=actions">GitHub Actions marketplace</a>. You can pass arguments by using the <code>with:</code> key to these prespecified actions.</p>
<p>The first step below just checks to see if we have set up a deploy key, something which should be done when we first set up a blog with fastpages:</p>

<pre><code>    - name: Check if secret exists
      if: github.event_name == 'push'
      run: |
        if [ -z "$deploy_key" ]
        then
          echo "You do not have a secret named SSH_DEPLOY_KEY.  This means you did not follow the setup instructions carefully.  Please try setting up your repo again with the right secrets."
          exit 1;
        fi
      env:
       deploy_key: $</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, it uses a marketplace action to checkout our blog repository and then uses a local action directory to convert our notebooks to markdown files. This conversion puts the markdown in the <code>_posts/</code> directory of the blog repository.</p>

<pre><code>    - name: Copy Repository Contents
      uses: actions/checkout@main
      with:
        persist-credentials: false

    - name: convert notebooks and word docs to posts
      uses: ./_action_files</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The final few steps build and deploy the Jekyll blog. First, the <code>_site/</code> directory is cleared and then rebuilt using a Docker container image. The CNAME step is only pertinent if you have a custom domain name, which this blog doesn't so can be ignored.</p>
<p>Finally the last action <code>peaceiris/actions-gh-pages@v3</code> takes the fresh <code>_site/</code> and deploys this to a Github Page, which allows hosting of static sites. Easy right?</p>

<pre><code>    - name: setup directories for Jekyll build
      run: |
        rm -rf _site
        sudo chmod -R 777 .

    - name: Jekyll build
      uses: docker://fastai/fastpages-jekyll
      with:
        args: bash -c "jekyll build -V --strict_front_matter --trace"
      env:
        JEKYLL_ENV: 'production'

    - name: copy CNAME file into _site if CNAME exists
      run: |
        sudo chmod -R 777 _site/
        cp CNAME _site/ 2&gt;/dev/null || :

    - name: Deploy
      if: github.event_name == 'push'
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: $
        publish_dir: ./_site</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-make-the-custom-header-image">How to make the custom header image<a class="anchor-link" href="#How-to-make-the-custom-header-image"> </a></h2><p>To make the custom header image I wrote a <a href="https://github.com/jc639/blog/blob/master/scripts/make_header.py">little script</a> of which the main execution function is shown below in the collapsable code fold. It's not too important to understand it for this explanation, just that it is simple python script that produces a matplotlib plot. The main thing is that it reads the markdown posts in the <code>_posts/</code> folder to get the titles and dates published, and then it can construct the plot with a list of the titles and time since today's date expressed in days.</p>
<p>As blog posts only ever get put in the <code>_posts/</code> directory at site build time and the resulting markdown is not committed to the repository I realised I can slot this script into the current <code>ci.yaml</code> workflow.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary class="btn btn-sm" data-open="Hide Code" data-close="Show Code"></summary>
        <p><div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">line_plot</span><span class="p">(</span><span class="n">post_titles</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">deltas</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=-</span><span class="mi">30</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the line plot in the XKCD style.</span>

<span class="sd">    Args:</span>
<span class="sd">        post_titles (list): list of post titles</span>
<span class="sd">        deltas (list): list of time since comparison time</span>
<span class="sd">        cutoff (int, optional): cutoff point. Defaults to -30.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple : plt.fig, plt.ax</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">xkcd</span><span class="p">():</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">x_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cutoff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">y_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
        <span class="n">y_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">y_counts</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">x_vals</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;WELCOME TO THE BLOG!&#39;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
        <span class="n">max_y_val</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_vals</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="n">max_y_val</span><span class="o">+</span><span class="mf">0.3</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y_counts</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_y_val</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Days ago...&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Number of posts&#39;</span><span class="p">)</span>

        <span class="n">arrowprops</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                        <span class="n">arrowstyle</span><span class="o">=</span><span class="s2">&quot;-&gt;&quot;</span><span class="p">,</span>
                        <span class="n">connectionstyle</span><span class="o">=</span><span class="s2">&quot;angle3,angleA=0,angleB=90&quot;</span><span class="p">)</span>
        <span class="n">titles_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">post_titles</span><span class="p">)</span>
        <span class="n">deltas_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
        <span class="n">x_offset</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">y_offset</span> <span class="o">=</span> <span class="n">max_y_val</span> <span class="o">+</span> <span class="mf">0.2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">y_counts</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.2</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">y_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">post_titles</span> <span class="o">=</span> <span class="n">titles_arr</span><span class="p">[</span><span class="n">deltas_arr</span> <span class="o">==</span> <span class="n">x</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">+</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">post_titles</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">count</span><span class="p">),</span>
                        <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">x_offset</span><span class="p">,</span> <span class="n">y_offset</span><span class="p">),</span>
                        <span class="n">arrowprops</span><span class="o">=</span><span class="n">arrowprops</span><span class="p">)</span>
            <span class="n">y_offset</span> <span class="o">-=</span> <span class="mf">0.2</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s1">&#39;Days since posting...&#39;</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
        <span class="n">bbox_props</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round&quot;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">ec</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">last_post_days</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">deltas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">last_post_days</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">cutoff</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">last_post_days</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="n">bbox_props</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>
        <span class="n">exclam</span> <span class="o">=</span> <span class="s1">&#39;&quot;Nice!&quot;&#39;</span> <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">last_post_days</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="k">else</span> <span class="s1">&#39;&quot;UH OH!&quot;&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">1.28</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">exclam</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">ax</span>
</pre></div>

    </div>
</div>
</div>
</p>
    </details>
</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here are the changes I made to make that work.</p>
<p>Firstly I had to add another trigger to the action. It's fine that it runs on push as I want new blog posts to be added to the header as they are published. But I also want it to update every day so that the time since publishing updates daily for each post. Handily, GitHub actions have a <code>schedule</code> trigger where we can set a schedule for the action to occur using Cron expressions.</p>

<pre><code>name: CI
on:
  push:
    branches:
      - master # need to filter here so we only deploy when there is a push to master
  # no filters on pull requests, so intentionally left blank
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"</code></pre>
<p>This Cron expression means the action will happen every day at 1 am. Check this handy website if you need to write Cron expression <a href="https://crontab.guru/">https://crontab.guru/</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Next, I slot the script and associated setup in between <code>- name: convert notebooks and word docs to posts</code> and the <code>- name: setup directories for Jekyll build steps</code>.</p>
<p>To use the script we need to have python and the required libraries installed. Luckily this is again quite easy using the <code>actions/setup-python</code> action followed by a <code>run: pip install -r requirements.txt</code> step. These are the <code>- name: setup python</code> and <code>- name: Install dependencies</code> steps, respectively.</p>
<p>The next step installs the humor sans font that is required by <code>plt.xkcd</code> and then finally we run the script in the <code>- name: make-header</code> step.</p>

<pre><code>    - name: convert notebooks and word docs to posts
      uses: ./_action_files

    - name: setup python
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install humor sans font
      run: |
        sudo apt-get update -y
        sudo apt-get install -y fonts-humor-sans
        rm -rf ~/.cache/matplotlib

    - name: make-header
      run: |
        python scripts/make_header.py

    - name: setup directories for Jekyll build
      run: |
        rm -rf _site
        sudo chmod -R 777 .</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The very last thing we have to change is the conditional <code>if:</code> in the final <code>- name: Deploy</code> step to also run this when the <code>github.event_name</code> is equal to 'schedule'. Viola!</p>

<pre><code>    - name: Deploy
      if: ( github.event_name == 'push' ) || ( github.event_name == 'schedule' )
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: $
        publish_dir: ./_site</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here is the new <code>ci.yaml</code> workflow file in full:</p>

<pre><code>name: CI
on:
  push:
    branches:
      - master # need to filter here so we only deploy when there is a push to master
  # no filters on pull requests, so intentionally left blank
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: "0 1 * * *"

jobs:     
  build-site:
    if: ( github.event.commits[0].message != 'Initial commit' ) || github.run_number &gt; 1
    runs-on: ubuntu-latest
    steps:

    - name: Check if secret exists
      if: ( github.event_name == 'push' ) || ( github.event_name == 'schedule' )
      run: |
        if [ -z "$deploy_key" ]
        then
          echo "You do not have a secret named SSH_DEPLOY_KEY.  This means you did not follow the setup instructions carefully.  Please try setting up your repo again with the right secrets."
          exit 1;
        fi
      env:
       deploy_key: $


    - name: Copy Repository Contents
      uses: actions/checkout@main
      with:
        persist-credentials: false

    - name: convert notebooks and word docs to posts
      uses: ./_action_files

    - name: setup python
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install humor sans font
      run: |
        sudo apt-get update -y
        sudo apt-get install -y fonts-humor-sans
        rm -rf ~/.cache/matplotlib

    - name: make-header
      run: |
        python scripts/make_header.py

    - name: setup directories for Jekyll build
      run: |
        rm -rf _site
        sudo chmod -R 777 .

    - name: Jekyll build
      uses: docker://fastai/fastpages-jekyll
      with:
        args: bash -c "jekyll build -V --strict_front_matter --trace"
      env:
        JEKYLL_ENV: 'production'

    - name: copy CNAME file into _site if CNAME exists
      run: |
        sudo chmod -R 777 _site/
        cp CNAME _site/ 2&gt;/dev/null || :

    - name: Deploy
      if: ( github.event_name == 'push' ) || ( github.event_name == 'schedule' )
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: $
        publish_dir: ./_site</code></pre>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jc639/blog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/blog/github/ci/actions/2021/03/06/github_actions.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/blog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/blog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/blog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A blog about data science things, mostly.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jc639" title="jc639"><svg class="svg-icon grey"><use xlink:href="/blog/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
